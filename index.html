<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>test shaker</title>

<script src="https://d309knd7es5f10.cloudfront.net/Box2dWeb-2.1.a.3.min.js"></script>
<script src="https://zimjs.org/cdn/016/zim_physics.js" type="module"></script>
<script type=module>

import zim from "https://zimjs.org/cdn/016/zim_physics";

// See Docs under Frame for FIT, FILL, FULL, and TAG
const assets = ["rock.png", "collisionSound.m4a", "bgSound.m4a"];
const path = "assets/";
new Frame(FIT, 430, 932, dark, darker, ready, assets, path);
function ready() {
    
    // given F (Frame), S (Stage), W (width), H (height)
    // put code here
    
    const fragment = ` // multiline string is backtick in top left keyboard

        #define SS(a,b,c) smoothstep(a-b,a+b,c)
        #define gyr(p) dot(sin(p.xyz),cos(p.zxy))
        #define T iTime
        #define R iResolution

        uniform float intensity;

        float map(in vec3 p) {
            return (1. + .2*sin(p.y*600.)) * 
            gyr(( p*(10.) + .8*gyr(( p*8. )) )) *
            (1.+sin(T+length(p.xy)*10.)) + 
            .3 * sin(T*.15 + p.z * 5. + p.y) *
            (2.+gyr(( p*(sin(T*.2+p.z*3.)*350.+250.) )));
        }

        vec3 norm(in vec3 p) {
            float m = map(p);
            vec2 d = vec2(.06+.06*sin(p.z),0.);
            return map(p)-vec3(
                map(p-d.xyy),map(p-d.yxy),map(p-d.yyx)
            );
        }

        vec3 rgb2hsv(vec3 c) {
            vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
            vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
            vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));

            float d = q.x - min(q.w, q.y);
            float e = 1.0e-10;
            return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
        }

        vec3 hsv2rgb(vec3 c) {
            vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
            vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
            return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
        }

        void mainImage( out vec4 color, in vec2 coord ) {
            vec2 uv = coord/R.xy;
            vec2 uvc = (coord-R.xy/2.)/R.y;
            float d = 0.;
            float dd = 1.;
            vec3 p = vec3(0.,0.,T/4.);
            vec3 rd = normalize(vec3(uvc.xy,1.));
            for (float i=0.;i<90. && dd>.001 && d < 2.;i++) {
                d += dd;
                p += rd*d;
                dd = map(p)*.02;
            }

            vec3 n = norm(p);
            float bw = n.x + n.y; 
            bw *= SS(.9, .15, 1.0 / d); 
            float brightness = clamp(bw * 0.5 + 0.5 * intensity, 0.0, 1.0);
            vec3 hsv = vec3(0.0, pow(intensity, 0.5), brightness);
            vec3 finalColor = hsv2rgb(hsv);
            color = vec4(finalColor, 1.0);
        }
 
    `; 

    const uniforms = new Uniforms({
        intensity: 0.0  // 初始值为0.0
    });

    // 使用Uniforms对象创建Shader
    let myShader = new Shader(W, H, fragment, uniforms).center();

    const statusLabel = new Label("Orientation: 0°", 20, "courier", "white").addTo().pos(20, 20);
    const gravityLabel = new Label("Gravity: 0, 0", 20, "courier", "white").addTo().pos(20, 95);
    const instruction = new Label("Long Press Anywhere", 20, "courier", "white").center();


    // 创建物理世界，初始无重力
    const physics = new Physics(0, null, true); 

    const collisionSound = new Aud("collisionSound.m4a");

    const bgSound = new Aud("bgSound.m4a", 1, true);

    // window.addEventListener('deviceorientation', handleOrientation); //for testing on Chrome

    // 创建请求权限按钮
    let requestButton = new Button({
        label: new Label("PERMISSION", 40,"courier"),
        width: 260,
        height: 40,
        backgroundColor: "white",
        rollBackgroundColor: "orangered",
        corner: 0
    }).pos(0,50,CENTER,BOTTOM); 

    requestButton.on("click", function() {

        if (typeof DeviceMotionEvent.requestPermission === 'function') {
            // 这是iOS 13+ 设备
            DeviceMotionEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        console.log("devicemotion listener added"); // 确认监听器已添加
                        requestButton.removeFrom();
                    } else {
                        alert("没有权限访问运动传感器");
                    }
                })
                .catch(error=>{
                    statusLabel.text = `Permission error: ${error}`;
                });
        } else {
            // 非iOS 13+ 设备
            window.addEventListener('deviceorientation', handleOrientation);
            requestButton.removeFrom();
            console.log("devicemotion listener added on non-iOS 13+ device");
            // statusLabel.text = "Permission API not needed or not supported.";
        }

        const gravityScale = 9.8;  // 实际重力加速度
        const scaleMultiplier = 1;  // 增加这个乘数以增强倾斜导致的重力效应

        function handleOrientation(event) {
            const alpha = event.alpha; // 0-360
            // const beta = Math.abs(event.beta); 
            const beta = event.beta; // -180到180
            const gamma = event.gamma; // -90到90
            const intensity = (alpha / 360 + beta / 180 + gamma / 90) / 3; // Normalize and average
            myShader.uniforms.intensity = intensity; // 更新着色器的intensity值
            statusLabel.text = `Orientation:\nα ${alpha.toFixed(2)}°\nβ ${beta.toFixed(2)}°\nγ ${gamma.toFixed(2)}°\nIntensity: ${intensity.toFixed(2)}`;

            // 根据beta和gamma调整重力
            const gravityX = Math.sin(gamma * Math.PI / 180) * gravityScale * scaleMultiplier;
            const gravityY = Math.sin(beta * Math.PI / 180) * gravityScale * scaleMultiplier;

            // 设置物理世界的重力
            physics.world.SetGravity(new Box2D.Common.Math.b2Vec2(gravityX, gravityY)); // 正确使用Box2D API设置重力
            
            // 获取并显示重力向量
            const gravityVector = physics.world.GetGravity();
            zog("gravity", gravityVector.x, gravityVector.y);
            gravityLabel.text = `Gravity: ${gravityVector.x.toFixed(2)}, ${gravityVector.y.toFixed(2)}`;
        }

        let longPressTimer;
        document.addEventListener("touchstart", function(e) {
            e.preventDefault();
            console.log("touch start");
            instruction.text = "";
            timeout(1,()=>{
                instruction.text = "Release to Create Rock";
            })
            longPressTimer = setTimeout(() => {

                let touch = e.changedTouches[0];
                // 获取触摸点相对于浏览器视口的位置
                let rect = S.canvas.getBoundingClientRect();
                // 转换触摸点坐标到相对于画布的位置
                let x = touch.clientX - rect.left;
                let y = touch.clientY - rect.top;
                // 转换坐标到舞台
                let localPoint = S.globalToLocal(x, y);
                console.log("Touch at stage:", localPoint.x, localPoint.y);
                createRock(localPoint.x, localPoint.y);
                
            }, 500); // 500毫秒长按阈值
        }, { passive: false });

        document.addEventListener("touchend", function(e) {
            console.log("touch end");
            instruction.text = "Long Press Anywhere";
            clearTimeout(longPressTimer);
        });

        function createRock(x, y) {
            const rock = new Pic("rock.png", path).sca(0).centerReg().addTo();   
            rock.x = x+50;
            rock.y = y+60;
            rock.animate({
                props: {scale: 0.4},
                time: 1,
                call: function() {
                    rock.addPhysics({
                        // bounciness: 0.7,
                        friction: 0.1,
                        linearDamping: 0.1,
                        shape: "circle"
                    }).contact(() => {
                        collisionSound.play();
                    });
                }
            });
            console.log(rock.x, rock.y);
            S.update();
        }

    });
        
} // end ready

</script>
<meta name="viewport" content="width=device-width, user-scalable=no" />
</head>
<body></body>
</html>